/**
 * Forgekeeper Layout Utilities
 *
 * Flexbox-based layout patterns for proper scrolling and responsive design.
 * All layouts designed to prevent scrolling issues by using proper flex containment.
 */

/* ========================================
 * MAIN LAYOUT STRUCTURE
 * ======================================== */

.main-layout {
  display: flex;
  flex-direction: column;
  height: 100vh;
  overflow: hidden;
  background: var(--bg-primary);
}

/* ========================================
 * HEADER
 * ======================================== */

.app-header {
  display: flex;
  align-items: center;
  gap: var(--gap-lg);
  padding: var(--padding-lg) var(--padding-xl);
  background: var(--bg-secondary);
  border-bottom: 1px solid var(--border-primary);
  flex-shrink: 0; /* Don't shrink */
  height: var(--header-height);
}

.app-header h1 {
  margin: 0;
  font-size: var(--font-2xl);
  color: var(--text-bright);
  font-weight: var(--font-semibold);
}

.header-actions {
  display: flex;
  align-items: center;
  gap: var(--gap-md);
  margin-left: auto;
}

/* ========================================
 * CONTENT WRAPPER (Main + Sidebar)
 * ======================================== */

.content-wrapper {
  display: flex;
  flex: 1;
  min-height: 0; /* Critical: allows flex children to scroll */
  overflow: hidden;
  gap: var(--gap-lg);
  padding: var(--padding-lg);
}

.main-content {
  flex: 1;
  min-width: 0; /* Prevents flex item from overflowing */
  overflow: hidden;
  display: flex;
  flex-direction: column;
}

/* ========================================
 * SIDEBAR (Thought World)
 * ======================================== */

.thought-world-sidebar {
  width: var(--sidebar-width);
  flex-shrink: 0;
  background: var(--bg-secondary);
  border: 1px solid var(--border-primary);
  border-radius: var(--radius-lg);
  padding: var(--padding-lg);
  overflow-y: auto;
  display: flex;
  flex-direction: column;
  gap: var(--gap-lg);
}

.sidebar-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding-bottom: var(--gap-md);
  border-bottom: 1px solid var(--border-secondary);
  flex-shrink: 0;
}

.sidebar-header h3 {
  margin: 0;
  font-size: var(--font-lg);
  color: var(--text-bright);
}

.session-id {
  font-size: var(--font-xs);
  color: var(--text-tertiary);
  font-family: var(--font-family-mono);
  background: var(--bg-tertiary);
  padding: 4px 8px;
  border-radius: var(--radius-sm);
}

/* Hide sidebar on smaller screens */
@media (max-width: 1024px) {
  .thought-world-sidebar {
    position: fixed;
    right: 0;
    top: 0;
    bottom: 0;
    z-index: var(--z-fixed);
    transform: translateX(100%);
    transition: transform var(--transition-base);
  }

  .thought-world-sidebar.visible {
    transform: translateX(0);
  }
}

/* ========================================
 * CHAT CONTAINER
 * ======================================== */

.chat-container {
  display: flex;
  flex-direction: column;
  height: 100%;
  overflow: hidden;
  gap: var(--gap-md);
}

/* Settings Panel (Collapsible) */
.settings-panel {
  flex-shrink: 0;
  background: var(--bg-secondary);
  border: 1px solid var(--border-primary);
  border-radius: var(--radius-lg);
  padding: var(--padding-lg);
  max-height: 300px;
  overflow-y: auto;
}

.settings-panel summary {
  cursor: pointer;
  font-size: var(--font-md);
  font-weight: var(--font-medium);
  color: var(--text-bright);
  user-select: none;
  list-style: none;
  display: flex;
  align-items: center;
  gap: var(--gap-sm);
}

.settings-panel summary::-webkit-details-marker {
  display: none;
}

.settings-panel summary::before {
  content: 'â–¶';
  display: inline-block;
  transition: transform var(--transition-fast);
  font-size: var(--font-sm);
  color: var(--text-secondary);
}

.settings-panel[open] summary::before {
  transform: rotate(90deg);
}

.settings-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
  gap: var(--gap-lg);
  margin-top: var(--gap-lg);
  padding-top: var(--gap-lg);
  border-top: 1px solid var(--border-secondary);
}

.setting-row {
  display: flex;
  flex-direction: column;
  gap: var(--gap-sm);
}

.setting-label {
  font-size: var(--font-sm);
  color: var(--text-secondary);
  font-weight: var(--font-medium);
}

.advanced-settings {
  grid-column: 1 / -1;
  background: var(--bg-primary);
  border: 1px solid var(--border-secondary);
  border-radius: var(--radius-md);
  padding: var(--padding-md);
  margin-top: var(--gap-md);
}

.advanced-settings summary {
  font-size: var(--font-sm);
  color: var(--text-secondary);
}

/* ========================================
 * MESSAGES AREA (Critical for Scrolling)
 * ======================================== */

.messages-container {
  flex: 1;
  min-height: 0; /* Critical: allows scrolling */
  overflow: hidden;
  background: var(--bg-secondary);
  border: 1px solid var(--border-primary);
  border-radius: var(--radius-lg);
  display: flex;
  flex-direction: column;
}

.messages-scroll {
  flex: 1;
  overflow-y: auto; /* Only this element scrolls */
  overflow-x: hidden;
  padding: var(--padding-lg);
  scroll-behavior: smooth;
}

.message-list {
  display: flex;
  flex-direction: column;
  gap: var(--gap-lg);
}

/* Message Bubble */
.message-bubble {
  display: flex;
  flex-direction: column;
  gap: var(--gap-sm);
  padding: var(--padding-md);
  border-radius: var(--radius-md);
  max-width: 85%;
}

.message-bubble.user {
  align-self: flex-end;
  background: var(--accent-blue-dark);
  border: 1px solid var(--accent-blue);
}

.message-bubble.assistant {
  align-self: flex-start;
  background: var(--bg-tertiary);
  border: 1px solid var(--border-primary);
}

.message-bubble.system {
  align-self: center;
  background: var(--bg-primary);
  border: 1px solid var(--border-secondary);
  max-width: 90%;
  font-size: var(--font-sm);
  color: var(--text-tertiary);
}

.message-bubble.tool {
  align-self: flex-start;
  background: var(--bg-primary);
  border-left: 3px solid var(--accent-yellow);
  max-width: 100%;
  font-family: var(--font-family-mono);
  font-size: var(--font-sm);
}

.message-header {
  display: flex;
  align-items: center;
  gap: var(--gap-sm);
  font-size: var(--font-xs);
  color: var(--text-tertiary);
  margin-bottom: var(--gap-xs);
}

.message-role {
  font-weight: var(--font-medium);
  text-transform: uppercase;
  letter-spacing: 0.5px;
}

.message-content {
  color: var(--text-primary);
  line-height: var(--line-height-relaxed);
  word-wrap: break-word;
  white-space: pre-wrap;
}

.message-reasoning {
  margin-top: var(--gap-md);
  padding-top: var(--gap-md);
  border-top: 1px solid var(--border-secondary);
  color: var(--text-secondary);
  font-size: var(--font-sm);
  font-style: italic;
}

/* ========================================
 * INPUT AREA (Fixed at Bottom)
 * ======================================== */

.input-container {
  flex-shrink: 0;
  display: flex;
  flex-direction: column;
  gap: var(--gap-sm);
  background: var(--bg-secondary);
  border: 1px solid var(--border-primary);
  border-radius: var(--radius-lg);
  padding: var(--padding-md);
}

.input-wrapper {
  display: flex;
  gap: var(--gap-sm);
  align-items: flex-end;
}

.input-textarea {
  flex: 1;
  min-height: 60px;
  max-height: 200px;
  resize: vertical;
  padding: var(--padding-md);
  background: var(--bg-primary);
  border: 1px solid var(--border-primary);
  border-radius: var(--radius-md);
  color: var(--text-primary);
  font-family: inherit;
  font-size: var(--font-base);
  line-height: var(--line-height-normal);
}

.input-textarea:focus {
  outline: none;
  border-color: var(--accent-blue);
}

.send-button {
  align-self: flex-end;
  padding: var(--padding-md) var(--padding-xl);
  min-width: 100px;
}

/* ========================================
 * STREAMING STATUS BAR
 * ======================================== */

.streaming-status {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: var(--padding-sm) var(--padding-md);
  background: var(--bg-primary);
  border: 1px solid var(--border-primary);
  border-radius: var(--radius-sm);
  font-size: var(--font-sm);
}

.streaming-status.active {
  border-color: var(--accent-green);
  background: var(--accent-green-dark);
}

.streaming-status.idle {
  border-color: var(--text-dim);
}

.streaming-status.error {
  border-color: var(--accent-red);
  background: var(--accent-red-dark);
}

.status-indicators {
  display: flex;
  align-items: center;
  gap: var(--gap-lg);
}

.status-indicator {
  display: flex;
  align-items: center;
  gap: var(--gap-xs);
  font-size: var(--font-xs);
  color: var(--text-tertiary);
}

.status-message {
  font-size: var(--font-sm);
  color: var(--text-secondary);
}

/* ========================================
 * AGENT PANELS (Thought World Sidebar)
 * ======================================== */

.agents-grid {
  display: flex;
  flex-direction: column;
  gap: var(--gap-md);
  flex: 1;
  overflow-y: auto;
}

.agent-panel {
  background: var(--bg-primary);
  border-radius: var(--radius-md);
  overflow: hidden;
  border: 1px solid var(--border-primary);
}

.agent-header {
  display: flex;
  align-items: center;
  gap: var(--gap-md);
  padding: var(--padding-md);
  background: var(--bg-secondary);
  border-bottom: 1px solid var(--border-primary);
}

.agent-panel.forge .agent-header {
  border-left: 4px solid var(--agent-forge);
}

.agent-panel.scout .agent-header {
  border-left: 4px solid var(--agent-scout);
}

.agent-panel.loom .agent-header {
  border-left: 4px solid var(--agent-loom);
}

.agent-panel.anvil .agent-header {
  border-left: 4px solid var(--agent-anvil);
}

.agent-icon {
  font-size: var(--font-xl);
}

.agent-info {
  flex: 1;
  min-width: 0;
}

.agent-name {
  font-size: var(--font-md);
  font-weight: var(--font-semibold);
  color: var(--text-bright);
  margin: 0;
}

.agent-role {
  font-size: var(--font-xs);
  color: var(--text-tertiary);
  margin: 0;
}

.agent-status {
  font-size: var(--font-xs);
  padding: 4px 8px;
  border-radius: var(--radius-sm);
  background: var(--bg-tertiary);
  color: var(--text-secondary);
  white-space: nowrap;
}

.agent-status.thinking {
  background: var(--accent-blue-dark);
  color: var(--accent-blue);
  animation: pulse 1.5s ease-in-out infinite;
}

.agent-status.done {
  background: var(--accent-green-dark);
  color: var(--accent-green);
}

.agent-status.error {
  background: var(--accent-red-dark);
  color: var(--accent-red);
}

.agent-content {
  padding: var(--padding-md);
  min-height: 100px;
  max-height: 300px;
  overflow-y: auto;
  font-size: var(--font-sm);
  line-height: var(--line-height-relaxed);
  color: var(--text-primary);
  white-space: pre-wrap;
  word-wrap: break-word;
}

.agent-content:empty::before {
  content: 'Waiting...';
  color: var(--text-dim);
  font-style: italic;
}

/* ========================================
 * CONSENSUS PANEL
 * ======================================== */

.consensus-panel {
  background: var(--bg-secondary);
  border: 1px solid var(--border-primary);
  border-radius: var(--radius-lg);
  padding: var(--padding-lg);
  flex-shrink: 0;
}

.consensus-header {
  font-size: var(--font-lg);
  font-weight: var(--font-semibold);
  color: var(--text-bright);
  margin-bottom: var(--gap-md);
}

.decision-badge {
  display: inline-block;
  padding: var(--padding-sm) var(--padding-lg);
  border-radius: var(--radius-md);
  font-size: var(--font-sm);
  font-weight: var(--font-semibold);
  margin-bottom: var(--gap-md);
  text-transform: uppercase;
  letter-spacing: 0.5px;
}

.decision-badge.approved {
  background: var(--accent-green-dark);
  color: var(--accent-green);
}

.decision-badge.approved_with_modifications {
  background: var(--accent-yellow-dark);
  color: var(--accent-yellow);
}

.decision-badge.rejected {
  background: var(--accent-red-dark);
  color: var(--accent-red);
}

.decision-badge.escalated {
  background: var(--accent-purple-dark);
  color: var(--accent-purple);
}

.consensus-content {
  color: var(--text-secondary);
  font-size: var(--font-sm);
  line-height: var(--line-height-relaxed);
  white-space: pre-wrap;
}

.episode-id {
  margin-top: var(--gap-md);
  font-size: var(--font-xs);
  color: var(--text-dim);
  font-family: var(--font-family-mono);
}

/* ========================================
 * RESPONSIVE UTILITIES
 * ======================================== */

@media (max-width: 768px) {
  .content-wrapper {
    flex-direction: column;
    padding: var(--padding-sm);
  }

  .thought-world-sidebar {
    width: 100%;
    max-height: 50vh;
  }

  .settings-grid {
    grid-template-columns: 1fr;
  }

  .message-bubble {
    max-width: 95%;
  }
}

/* ========================================
 * LOADING STATES
 * ======================================== */

.loading-spinner {
  display: inline-block;
  width: 16px;
  height: 16px;
  border: 2px solid var(--border-primary);
  border-top-color: var(--accent-blue);
  border-radius: 50%;
  animation: spin 0.8s linear infinite;
}

.loading-skeleton {
  background: linear-gradient(
    90deg,
    var(--bg-secondary) 25%,
    var(--bg-tertiary) 50%,
    var(--bg-secondary) 75%
  );
  background-size: 200% 100%;
  animation: shimmer 1.5s ease-in-out infinite;
  border-radius: var(--radius-sm);
}

@keyframes shimmer {
  0% {
    background-position: -200% 0;
  }
  100% {
    background-position: 200% 0;
  }
}

/* ========================================
 * MODAL/DRAWER PATTERNS
 * ======================================== */

.modal-backdrop {
  position: fixed;
  inset: 0;
  background: rgba(0, 0, 0, 0.7);
  z-index: var(--z-modal-backdrop);
  display: flex;
  align-items: center;
  justify-content: center;
  padding: var(--padding-xl);
}

.modal {
  background: var(--bg-secondary);
  border: 1px solid var(--border-primary);
  border-radius: var(--radius-lg);
  max-width: min(900px, 95vw);
  max-height: 90vh;
  overflow: auto;
  box-shadow: var(--shadow-xl);
  position: relative;
}

.modal-close {
  position: absolute;
  top: var(--padding-md);
  right: var(--padding-md);
  background: transparent;
  border: none;
  color: var(--text-secondary);
  font-size: var(--font-xl);
  cursor: pointer;
  padding: var(--padding-xs);
  line-height: 1;
}

.modal-close:hover {
  color: var(--text-bright);
  background: var(--bg-tertiary);
  border-radius: var(--radius-sm);
}

/* ========================================
 * FLEX UTILITIES
 * ======================================== */

.flex { display: flex; }
.flex-col { flex-direction: column; }
.flex-row { flex-direction: row; }
.flex-wrap { flex-wrap: wrap; }
.flex-1 { flex: 1; }
.flex-shrink-0 { flex-shrink: 0; }
.flex-grow-0 { flex-grow: 0; }

.items-center { align-items: center; }
.items-start { align-items: flex-start; }
.items-end { align-items: flex-end; }
.items-stretch { align-items: stretch; }

.justify-center { justify-content: center; }
.justify-start { justify-content: flex-start; }
.justify-end { justify-content: flex-end; }
.justify-between { justify-content: space-between; }
.justify-around { justify-content: space-around; }

.self-center { align-self: center; }
.self-start { align-self: flex-start; }
.self-end { align-self: flex-end; }
