version: "3.9"
services:
  mongodb:
    image: mongo:6
    profiles: [backend]
    networks: [forgekeeper-net]
    ports: ["27017:27017"]
    volumes:
      - mongo-data:/data/db

  vllm-core:
    image: forgekeeper-vllm
    profiles: [inference]
    build:
      context: .
      dockerfile: Dockerfile.vllm
      args:
        VLLM_BASE_IMAGE: ${VLLM_DOCKER_IMAGE:-vllm/vllm-openai:latest}
    env_file: ./.env
    environment:
      HF_HOME: /root/.cache/huggingface
      HUGGINGFACE_HUB_CACHE: /root/.cache/huggingface
      VLLM_LOG_DIR: /var/log/vllm
    networks: [forgekeeper-net]
    ports: ["${VLLM_PORT_CORE:-8001}:${VLLM_CONTAINER_PORT:-8000}"]
    ipc: host
    runtime: nvidia
    device_requests:
      - driver: nvidia
        count: all
        capabilities: [gpu]
    volumes:
      - ${VLLM_HF_CACHE_HOST_DIR:-./volumes/vllm-cache}:/root/.cache/huggingface
      - ${VLLM_MODELS_HOST_DIR:-./volumes/vllm-models}:/models
      - ${VLLM_LOGS_HOST_DIR:-./volumes/vllm-logs}:/var/log/vllm
    entrypoint: ["./scripts/run_vllm_core.sh"]

  vllm-coder:
    image: forgekeeper-vllm
    profiles: [inference]
    build:
      context: .
      dockerfile: Dockerfile.vllm
      args:
        VLLM_BASE_IMAGE: ${VLLM_DOCKER_IMAGE:-vllm/vllm-openai:latest}
    env_file: ./.env
    environment:
      HF_HOME: /root/.cache/huggingface
      HUGGINGFACE_HUB_CACHE: /root/.cache/huggingface
      VLLM_LOG_DIR: /var/log/vllm
    networks: [forgekeeper-net]
    ports: ["${VLLM_PORT_CODER:-8002}:${VLLM_CONTAINER_PORT:-8000}"]
    ipc: host
    runtime: nvidia
    device_requests:
      - driver: nvidia
        count: all
        capabilities: [gpu]
    volumes:
      - ${VLLM_HF_CACHE_HOST_DIR:-./volumes/vllm-cache}:/root/.cache/huggingface
      - ${VLLM_MODELS_HOST_DIR:-./volumes/vllm-models}:/models
      - ${VLLM_LOGS_HOST_DIR:-./volumes/vllm-logs}:/var/log/vllm
    entrypoint: ["./scripts/run_vllm_coder.sh"]

  backend:
    image: forgekeeper-backend
    build:
      context: ./backend
    profiles: [backend]
    env_file: ./.env
    environment:
      DATABASE_URL: mongodb://mongodb:27017/forgekeeper
      PORT: ${BACKEND_PORT}
    networks: [forgekeeper-net]
    ports: ["${BACKEND_PORT}:${BACKEND_PORT}"]
    depends_on:
      - mongodb

  backend-worker:
    image: forgekeeper-backend
    profiles: [agent-worker]
    env_file: ./.env
    environment:
      DATABASE_URL: mongodb://mongodb:27017/forgekeeper
      MQTT_BROKER: mqtt
    command: ["npm","run","worker","--prefix","backend"]
    networks: [forgekeeper-net]
    depends_on:
      - backend

  frontend:
    image: forgekeeper-frontend
    profiles: [ui]
    env_file: ./.env
    networks: [forgekeeper-net]
    ports: ["${FRONTEND_PORT}:80"]

  python:
    image: forgekeeper-python
    profiles: [agent]
    env_file: ./.env
    networks: [forgekeeper-net]
    ports: ["${PYTHON_PORT}:${PYTHON_PORT}"]
    depends_on:
      - vllm-core
      - vllm-coder

networks:
  forgekeeper-net:
    external: true

volumes:
  mongo-data:
