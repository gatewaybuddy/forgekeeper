version: "3.9"
services:
  mongodb:
    image: mongo:6
    profiles: [backend]
    networks: [forgekeeper-net]
    ports: ["27017:27017"]
    volumes:
      - mongo-data:/data/db

  vllm-core:
    image: forgekeeper-vllm
    profiles: [inference]
    build:
      context: .
      dockerfile: Dockerfile.vllm
    env_file: ./.env
    networks: [forgekeeper-net]
    ports: ["${VLLM_PORT_CORE}:${VLLM_PORT_CORE}"]
    entrypoint: ["./scripts/run_vllm_core.sh"]

  vllm-coder:
    image: forgekeeper-vllm
    profiles: [inference]
    build:
      context: .
      dockerfile: Dockerfile.vllm
    env_file: ./.env
    networks: [forgekeeper-net]
    ports: ["${VLLM_PORT_CODER}:${VLLM_PORT_CODER}"]
    entrypoint: ["./scripts/run_vllm_coder.sh"]

  backend:
    image: forgekeeper-backend
    profiles: [backend]
    env_file: ./.env
    environment:
      DATABASE_URL: mongodb://mongodb:27017/forgekeeper
    networks: [forgekeeper-net]
    ports: ["${BACKEND_PORT}:${BACKEND_PORT}"]
    depends_on:
      - mongodb

  backend-worker:
    image: forgekeeper-backend
    profiles: [agent-worker]
    env_file: ./.env
    environment:
      DATABASE_URL: mongodb://mongodb:27017/forgekeeper
      MQTT_BROKER: mqtt
    command: ["npm","run","worker","--prefix","backend"]
    networks: [forgekeeper-net]
    depends_on:
      - backend

  frontend:
    image: forgekeeper-frontend
    profiles: [ui]
    env_file: ./.env
    networks: [forgekeeper-net]
    ports: ["${FRONTEND_PORT}:80"]

  python:
    image: forgekeeper-python
    profiles: [agent]
    env_file: ./.env
    networks: [forgekeeper-net]
    ports: ["${PYTHON_PORT}:${PYTHON_PORT}"]
    depends_on:
      - vllm-core
      - vllm-coder

networks:
  forgekeeper-net:
    external: true

volumes:
  mongo-data:
