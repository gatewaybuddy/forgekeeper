name: Merge Gates

on:
  pull_request:
    types: [opened, synchronize, reopened, labeled, unlabeled, ready_for_review]

jobs:
  check:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      actions: read
      pull-requests: read
      statuses: read
    steps:
      - name: Enforce merge gates
        uses: actions/github-script@v7
        with:
          script: |
            const pr = context.payload.pull_request;
            const { owner, repo } = context.repo;
            const labels = pr.labels.map(l => l.name);
            if (labels.includes('override:emergency')) {
              core.info('override:emergency label present; bypassing gates.');
              return;
            }
            if (!labels.includes('review:approved')) {
              core.setFailed('Missing required label: review:approved');
            }
            const sha = pr.head.sha;
            const checkRuns = await github.paginate(github.rest.checks.listForRef, {
              owner, repo, ref: sha
            });
            const incomplete = checkRuns.filter(c => c.status !== 'completed' && c.name !== process.env.GITHUB_WORKFLOW);
            const failing = checkRuns.filter(c => c.conclusion !== 'success' && c.conclusion !== 'skipped' && c.name !== process.env.GITHUB_WORKFLOW);
            if (incomplete.length) {
              core.setFailed('CI checks are still running');
            }
            if (failing.length) {
              core.setFailed('CI checks failed: ' + failing.map(f => f.name).join(', '));
            }
            const runs = await github.paginate(github.rest.actions.listWorkflowRunsForCommit, {
              owner, repo, commit_sha: sha
            });
            let hasReview = false;
            for (const run of runs) {
              const artifacts = await github.paginate(github.rest.actions.listWorkflowRunArtifacts, {
                owner, repo, run_id: run.id
              });
              if (artifacts.some(a => a.name === 'self-review')) {
                hasReview = true;
                break;
              }
            }
            if (!hasReview) {
              core.setFailed('Missing self-review artifact');
            }
