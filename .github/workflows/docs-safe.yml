name: docs-safe

on:
  pull_request:
    types: [opened, synchronize, reopened, edited]

jobs:
  docs_only_check:
    if: startsWith(github.event.pull_request.title, '[docs]')
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
        with:
          fetch-depth: 0
      - name: Check allowed files
        run: |
          base_ref="${{ github.event.pull_request.base.ref }}"
          git fetch origin "$base_ref" --depth=1
          CHANGED=$(git diff --name-only "origin/$base_ref"...HEAD)
          echo "$CHANGED" | sed 's/^/ - /'
          BAD=$(echo "$CHANGED" | grep -Ev '^(README.md|docs/|forgekeeper/\.env\.example|frontend/test/)' || true)
          if [ -n "$BAD" ]; then
            echo "Disallowed files changed:" >&2
            echo "$BAD" | sed 's/^/ - /' >&2
            exit 1
          fi
      - name: Require Task ID in title or body
        run: |
          TITLE="${{ github.event.pull_request.title }}"
          BODY="${{ github.event.pull_request.body }}"
          if echo "$TITLE\n$BODY" | grep -Eiq '(Task ID:\s*T\d+|\bT[0-9]{2,5}\b)'; then
            echo "Task ID found"
          else
            echo "Missing Task ID (e.g., 'Task ID: T123')." >&2
            exit 1
          fi
      - name: Frontend unit tests (if tests touched)
        if: contains(github.event.pull_request.title, '[docs]')
        uses: actions/setup-node@v6
        with:
          node-version: '20'
      - name: Run frontend tests (docs-safe)
        if: contains(github.event.pull_request.title, '[docs]')
        run: |
          npm --prefix forgekeeper/frontend ci || npm --prefix forgekeeper/frontend install
          npm --prefix forgekeeper/frontend run test -s
