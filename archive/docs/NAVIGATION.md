# Navigation Data Exports

This document explains how to regenerate the repository navigation metadata that
agents rely on for reasoning about Python modules and the TypeScript frontend
and backend projects. The tooling produces cacheable JSON artifacts under
`.forgekeeper/cache/` so subsequent runs can reuse the data without re-parsing
source files.

## Prerequisites

* Python 3.11+ (matches the runtime used for Forgekeeper tooling).
* Node.js 18+ with the workspace dependencies installed (`npm install` in both
  `frontend/` and `backend/`). The exporter uses the TypeScript compiler API
  that ships with each project to walk import graphs.

## Step 1 – Build (or refresh) the module index

The dependency exporter consumes the module index generated by
`tools/nav/build_module_index.py` whenever it is available. Running the indexer
first ensures that package `__init__` files and standalone modules resolve
correctly in the Python import graph.

```bash
python tools/nav/build_module_index.py
```

By default the indexer writes `module_index.json` at the repository root. The
exporter also checks `.forgekeeper/cache/module_index.json` if you prefer to
stash a copy inside the cache directory.【F:tools/nav/export_dependencies.py†L30-L47】【F:tools/nav/export_dependencies.py†L152-L198】

## Step 2 – Export dependency graphs

Invoke the exporter from the repository root:

```bash
python tools/nav/export_dependencies.py
```

Key options include:

* `--module-index PATH` to point at a custom module index.
* `--frontend` / `--backend` to override the project directories.
* `--frontend-tsconfig` / `--backend-tsconfig` if the TypeScript configs live
  somewhere other than `tsconfig.json`.

All artifacts land in `.forgekeeper/cache/` (which is git-ignored) and include
timestamps so agents can tell when the cache was generated.【F:tools/nav/export_dependencies.py†L55-L80】【F:tools/nav/export_dependencies.py†L307-L352】

### Python import graph

`python_import_graph.json` captures every discovered module. Each entry records
its relative file path, the modules it imports, and which of those imports point
back into the repository. Summary statistics (module counts and edge counts) sit
alongside the per-module detail to help downstream tooling gauge graph size.【F:tools/nav/export_dependencies.py†L200-L259】【F:tools/nav/export_dependencies.py†L279-L305】

### Frontend and backend dependency graphs

The exporter shells out to a small Node.js helper that uses the TypeScript
compiler API to walk ASTs and collect import/require statements for each source
file. It resolves the `typescript` package relative to the project root so the
analysis works with the versions already pinned in `package.json`. Each graph
captures the analysis status, tsconfig used, and a mapping from file paths to
sorted dependency lists.【F:tools/nav/export_dependencies.py†L33-L47】【F:tools/nav/export_dependencies.py†L81-L150】【F:tools/nav/export_dependencies.py†L320-L349】

### Summary snapshot

For convenience the exporter also writes `dependency_summary.json` that packages
the Python stats and the raw frontend/backend graph metadata into a single file.
Pass `--no-summary` if you only want the per-language artifacts.【F:tools/nav/export_dependencies.py†L354-L369】

## Consuming the data

The JSON structures are intentionally straightforward. A quick way to inspect
outputs is to pipe them through `jq`, for example:

```bash
jq '.modules["forgekeeper.git_committer"].imports' \
  .forgekeeper/cache/python_import_graph.json
```

Because the cache directory is ignored by git you can safely regenerate the
artifacts as often as needed without polluting commits. Downstream navigation or
indexing tools should watch the `generated_at` timestamps to decide when to
refresh cached views.【F:tools/nav/export_dependencies.py†L307-L352】

## Command line helpers

The `tools.nav` package exposes a CLI that wraps the JSON artifacts, making it
easy to explore module metadata without memorising file paths. Install shell
completions once with:

```bash
python -m tools.nav --print-completion bash | source /dev/stdin
```

Example commands:

```bash
python -m tools.nav list-modules --package forgekeeper
python -m tools.nav show-module forgekeeper.task_pipeline
python -m tools.nav related-files task_pipeline
```

Targets in the repository `Makefile` (e.g. `make nav-list`) forward to these
commands for quick access.【F:tools/nav/__main__.py†L1-L301】
