#!/usr/bin/env bash
#
# Forgekeeper - Multi-Agent System Launcher
#
# Starts the Forgekeeper Conversation Space system with Docker containers
# Usage: forgekeeper [start|stop|restart|logs|status|build]
#

set -e

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# Find project root
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(dirname "$SCRIPT_DIR")"

# Change to project root
cd "$PROJECT_ROOT" || exit 1

# Functions
info() {
    echo -e "${BLUE}â„¹${NC} $1"
}

success() {
    echo -e "${GREEN}âœ“${NC} $1"
}

warn() {
    echo -e "${YELLOW}âš ${NC} $1"
}

error() {
    echo -e "${RED}âœ—${NC} $1"
}

# Ensure Docker network exists
ensure_network() {
    if ! docker network inspect forgekeeper-net >/dev/null 2>&1; then
        info "Creating Docker network: forgekeeper-net"
        docker network create forgekeeper-net
        success "Network created"
    fi
}

# Check if .env exists
check_env() {
    if [[ ! -f .env ]]; then
        error ".env file not found!"
        info "Copy .env.example to .env and configure your API keys"
        exit 1
    fi
}

# Start containers
start() {
    info "Starting Forgekeeper Conversation Space..."

    check_env
    ensure_network

    # Start with ui profile (frontend + chromadb)
    info "Building and starting containers..."
    docker compose --profile ui up -d --build

    echo ""
    info "Waiting for services to be ready..."
    sleep 5

    # Check container status
    if docker compose ps | grep -q "frontend.*Up"; then
        success "Frontend server is running"
    else
        warn "Frontend may not be ready yet"
    fi

    if docker compose ps | grep -q "chromadb.*Up"; then
        success "ChromaDB is running"
    else
        warn "ChromaDB may not be ready yet"
    fi

    echo ""
    success "Forgekeeper Conversation Space is ready!"
    echo ""
    echo -e "  ðŸ¤– Multi-Agent UI: ${GREEN}http://localhost:3000/conversation${NC}"
    echo -e "  ðŸŒ Main Chat:      ${GREEN}http://localhost:3000${NC} ${YELLOW}(requires local inference)${NC}"
    echo ""
    echo -e "  ðŸ“Š Status: Run '${YELLOW}forgekeeper status${NC}' to check agent status"
    echo -e "  ðŸ“œ Logs:   Run '${YELLOW}forgekeeper logs${NC}' to view logs"
    echo ""
    info "Active Agents (GPT-5.2): Forge (ðŸ”¨), Scout (ðŸ”­), Loom (ðŸ§µ), Anvil (âš’ï¸)"
    echo ""
}

# Stop containers
stop() {
    info "Stopping Forgekeeper..."
    docker compose --profile ui down
    success "Containers stopped"
}

# Restart containers
restart() {
    info "Restarting Forgekeeper..."
    stop
    sleep 2
    start
}

# Show Docker logs
logs() {
    docker compose --profile ui logs -f --tail=100
}

# Show log locations and commands (from Python CLI)
help() {
    python3 -m forgekeeper logs "$@"
}

# Show status
status() {
    info "Forgekeeper Status:"
    echo ""
    docker compose --profile ui ps
    echo ""

    # Try to get agent status from API
    if curl -s http://localhost:3000/api/conversation-space/status >/dev/null 2>&1; then
        info "Agent Status:"
        curl -s http://localhost:3000/api/conversation-space/status | python3 -c "
import sys, json
try:
    data = json.load(sys.stdin)
    if data.get('success'):
        agents = data.get('agents', [])
        for agent in agents:
            status_icon = 'âœ“' if agent['running'] else 'âœ—'
            print(f\"  {status_icon} {agent['icon']} {agent['name']:<8} ({agent['role']:<12}) - Threshold: {agent['threshold']}\")
    else:
        print('  âš  API returned error')
except:
    print('  âš  Could not parse status')
" 2>/dev/null || echo "  âš  Could not fetch agent status"
    else
        warn "API not responding - containers may still be starting up"
        info "Run 'forgekeeper logs' to check startup progress"
    fi
    echo ""
}

# Build containers
build() {
    info "Building Forgekeeper containers..."
    ensure_network
    docker compose --profile ui build
    success "Build complete"
}

# Show basic usage
usage() {
    echo "Forgekeeper - Multi-Agent Conversation Space System"
    echo ""
    echo "Usage: forgekeeper [command] [options]"
    echo ""
    echo "Container Management:"
    echo "  start         Start all containers (default)"
    echo "  stop          Stop all containers"
    echo "  restart       Restart all containers"
    echo "  build         Build container images"
    echo "  logs          Follow live Docker logs"
    echo "  status        Show container and agent status"
    echo ""
    echo "Information & Logs:"
    echo "  help          Show log locations and useful commands"
    echo "  help --category <type>   Filter help by category:"
    echo "                           conversation, system, memory, docker, all"
    echo ""
    echo "Python CLI (pass-through to 'python -m forgekeeper'):"
    echo "  compose       Start stack with compose"
    echo "  chat          Send a chat prompt"
    echo "  ensure-stack  Ensure full stack is up"
    echo "  switch-core   Switch inference core (llama|vllm)"
    echo ""
    echo "Examples:"
    echo "  forgekeeper start"
    echo "  forgekeeper help"
    echo "  forgekeeper help --category conversation"
    echo "  forgekeeper chat -p 'Hello world'"
    echo ""
    echo "After starting, access the UI at: http://localhost:3000"
    echo ""
}

# Main command dispatcher
COMMAND="${1:-start}"

case "$COMMAND" in
    start)
        start
        ;;
    stop)
        stop
        ;;
    restart)
        restart
        ;;
    logs)
        logs
        ;;
    status)
        status
        ;;
    build)
        build
        ;;
    help)
        # Pass all arguments to the Python CLI help
        shift
        help "$@"
        ;;
    --help|-h)
        usage
        ;;
    # Pass-through to Python CLI for these commands
    compose|chat|ensure-stack|switch-core|up-core|talk|repl|consciousness|c)
        python3 -m forgekeeper "$@"
        ;;
    *)
        error "Unknown command: $COMMAND"
        echo ""
        usage
        exit 1
        ;;
esac
