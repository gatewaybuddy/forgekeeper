FROM nvidia/cuda:12.1.1-cudnn8-runtime-ubuntu22.04

# Install Python and build essentials
RUN apt-get update && apt-get install -y --no-install-recommends \
    python3 python3-pip && \
    rm -rf /var/lib/apt/lists/*

# Install CUDA-enabled PyTorch and vLLM
RUN pip3 install --no-cache-dir torch --index-url https://download.pytorch.org/whl/cu121 && \
    pip3 install --no-cache-dir vllm

# Copy runtime scripts
WORKDIR /app
COPY scripts/run_vllm_core.sh scripts/run_vllm_coder.sh ./scripts/
RUN chmod +x ./scripts/run_vllm_core.sh ./scripts/run_vllm_coder.sh

# Default ports for Core and Coder
ENV VLLM_PORT_CORE=8000 \
    VLLM_PORT_CODER=8001
EXPOSE $VLLM_PORT_CORE $VLLM_PORT_CODER

ENTRYPOINT ["/bin/bash"]
CMD ["scripts/run_vllm_core.sh"]
